"use strict";var F=require("node:worker_threads"),f=require("../node-features-CKvB621_.cjs"),j=require("../register-SR2QYUsS.cjs"),y=require("node:url"),v=require("../index-DTCJysGI.cjs"),p=require("../file-url-BcwMOquI.cjs"),k=require("../client-DjommMgI.cjs"),w=require("node:path"),m=require("get-tsconfig"),q=require("node:fs");require("node:module"),require("esbuild"),require("node:crypto"),require("node:os"),require("../temporary-directory-B83uKxJF.cjs"),require("node:net"),require("../get-pipe-path-b8D5AZgV.cjs");const u={active:!0},J=async e=>{if(!e)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);u.namespace=e.namespace,e.port&&(u.port=e.port,e.port.on("message",t=>{t==="deactivate"&&(u.active=!1,e.port.postMessage({type:"deactivated"}))}))},M=()=>"process.setSourceMapsEnabled(true);",l=new Map,A=async e=>{if(l.has(e))return l.get(e);if(!await q.promises.access(e).then(()=>!0,()=>!1)){l.set(e,void 0);return}const a=await q.promises.readFile(e,"utf8");try{const r=JSON.parse(a);return l.set(e,r),r}catch{throw new Error(`Error parsing: ${e}`)}},$=async e=>{let t=new URL("package.json",e);for(;!t.pathname.endsWith("/node_modules/package.json");){const a=y.fileURLToPath(t),r=await A(a);if(r)return r;const o=t;if(t=new URL("../package.json",t),t.pathname===o.pathname)break}},D=async e=>(await $(e))?.type??"commonjs",d=process.env.TSX_TSCONFIG_PATH?{path:w.resolve(process.env.TSX_TSCONFIG_PATH),config:m.parseTsconfig(process.env.TSX_TSCONFIG_PATH)}:m.getTsconfig(),I=d&&m.createFilesMatcher(d),O=d&&m.createPathsMatcher(d),b=d?.config.compilerOptions?.allowJs??!1,_=/\.([cm]?ts|[tj]sx)($|\?)/,L=/\.json(?:$|\?)/,C=e=>{const t=w.extname(e.split("?")[0]);if(t===".json")return"json";if(t===".mjs"||t===".mts")return"module";if(t===".cjs"||t===".cts")return"commonjs"},G=e=>{const t=C(e);if(t)return t;if(_.test(e))return D(e)},g="tsx-namespace=",h=e=>{const t=e.indexOf(g);if(t===-1)return;const a=e[t-1];if(a!=="?"&&a!=="&")return;const r=t+g.length,o=e.indexOf("&",r);return o===-1?e.slice(r):e.slice(r,o)},P=f.isFeatureSupported(f.importAttributes)?"importAttributes":"importAssertions",Q=async(e,t,a)=>{if(!u.active||u.namespace&&u.namespace!==h(e))return a(e,t);if(u.port){const n=new URL(e);n.searchParams.delete("tsx-namespace"),u.port.postMessage({type:"load",url:n.toString()})}k.parent.send&&k.parent.send({type:"dependency",path:e}),L.test(e)&&(t[P]||(t[P]={}),t[P].type="json");const r=await a(e,t);if(!r.source)return r;const o=e.startsWith("file://")?y.fileURLToPath(e):e,s=r.source.toString();if(r.format==="json"||_.test(e)){const n=await v.transform(s,o,{tsconfigRaw:I?.(o)});return{format:"module",source:p.inlineSourceMap(n)}}if(r.format==="module"){const n=v.transformDynamicImport(o,s);n&&(r.source=p.inlineSourceMap(n))}return r},U=/\/(?:$|\?)/,T=async(e,t,a)=>{const r=await e(t,a);return!r.format&&r.url.startsWith(p.fileUrlPrefix)&&(r.format=await G(r.url)),r},W=[".js",".json",".ts",".tsx",".jsx"],E=async(e,t,a)=>{const[r,o]=e.split("?");let s;for(const n of W)try{return await T(a,r+n+(o?`?${o}`:""),t)}catch(c){if(s===void 0&&c instanceof Error){const{message:i}=c;c.message=c.message.replace(`${n}'`,"'"),c.stack=c.stack.replace(i,c.message),s=c}}throw s},R=async(e,t,a)=>{const r=U.test(e),o=r?"index":"/index",[s,n]=e.split("?");try{return await E(s+o+(n?`?${n}`:""),t,a)}catch(c){if(!r)try{return await E(e,t,a)}catch{}const i=c,{message:S}=i;throw i.message=i.message.replace(`${o.replace("/",w.sep)}'`,"'"),i.stack=i.stack.replace(S,i.message),i}},N=async(e,t,a,r)=>{if(!u.active)return a(e,t);const o=t.parentURL&&h(t.parentURL);if(p.requestAcceptsQuery(e)){let s=h(e);if(o&&!s&&(s=o,e+=`${e.includes("?")?"&":"?"}${g}${o}`),u.namespace&&u.namespace!==s)return a(e,t);if(U.test(e))return await R(e,t,a)}else if(O&&!t.parentURL?.includes("/node_modules/")){const s=O(e);for(const n of s)try{return await N(y.pathToFileURL(n).toString(),t,a)}catch{}}if(_.test(t.parentURL)||b){const s=p.resolveTsPath(e);if(s)for(const n of s)try{return await T(a,n,t)}catch(c){const{code:i}=c;if(i!=="ERR_MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const s=await T(a,e,t);if(p.requestAcceptsQuery(s.url)){const n=h(s.url);o&&!n&&(s.url+=`${s.url.includes("?")?"&":"?"}${g}${o}`)}return s}catch(s){if(s instanceof Error&&!r){const{code:n}=s;if(n==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await R(e,t,a)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(n==="ERR_MODULE_NOT_FOUND")try{return await E(e,t,a)}catch{}}throw s}};f.isFeatureSupported(f.moduleRegister)&&F.isMainThread&&j.register(),exports.globalPreload=M,exports.initialize=J,exports.load=Q,exports.resolve=N;
